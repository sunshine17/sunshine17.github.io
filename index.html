<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>PHP7 Experience by sunshine17</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>
      <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/sunshine17">View On GitHub</a></li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">

      <section>
        <div id="title">
          <h1>PHP7 Experience</h1>
          <p></p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/sunshine17">sunshine17</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>

        <h1>
<a id="先说结论" class="anchor" href="#%E5%85%88%E8%AF%B4%E7%BB%93%E8%AE%BA" aria-hidden="true"><span class="octicon octicon-link"></span></a>先说结论</h1>

<p>这是一个皆大欢喜的版本升级，节省服务器硬件成本，开发者欢欣拥抱: </p>

<ul>
<li>性能提升效果明显，在我的老PC机上比5.6提升至少30%</li>
<li>语法引入了时下主流的其它语言都有的特性，使开发效率得到明显的提升</li>
<li>不兼容旧版本的地方不多，基本不会触碰到</li>
</ul>

<h1>
<a id="新特性" class="anchor" href="#%E6%96%B0%E7%89%B9%E6%80%A7" aria-hidden="true"><span class="octicon octicon-link"></span></a>新特性</h1>

<h2>
<a id="更简洁更彻底的closure----closurecall" class="anchor" href="#%E6%9B%B4%E7%AE%80%E6%B4%81%E6%9B%B4%E5%BD%BB%E5%BA%95%E7%9A%84closure----closurecall" aria-hidden="true"><span class="octicon octicon-link"></span></a>更简洁，更彻底的Closure -- Closure::call()</h2>

<p>在javascript里，很简单的this绑定:</p>

<pre><code>function full_name(last_name){ 
    return this.first_name + '.' + last_name; 
}
// below returns "Jack.London"
full_name.apply({first_name: 'Jack'}, ['London'])   

</code></pre>

<p>PHP7通过Closure::call()实现：</p>

<pre><code>&lt;?php
class A {private $x = 1;}

// PHP7 前
$getXCB = function() {return $this-&gt;x;};
$getX = $getXCB-&gt;bindTo(new A, 'A'); // intermediate closure
echo $getX();

// PHP7 后
$getX = function() {return $this-&gt;x;};
echo $getX-&gt;call(new A);

// 会输出
// 1
// 1
</code></pre>

<h2>
<a id="generator的优化" class="anchor" href="#generator%E7%9A%84%E4%BC%98%E5%8C%96" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generator的优化</h2>

<ul>
<li>加入return语句
Generator是PHP5.5开始加入的特性，当时在Generator里不能有return语句，若要取得最后一个元素只能由调用者检查是否已取得最后一个元素。PHP7后，可以直接调用Generator::getReturn()来获取最后一个元素。例如:</li>
</ul>

<pre><code>&lt;?php

$gen = (function() {
    yield 1;
    yield 2;

    return 3;
})();

foreach ($gen as $val) {
    echo $val, PHP_EOL;
}

echo $gen-&gt;getReturn(), PHP_EOL;

// Output: 
// 1
// 2
// 3
</code></pre>

<ul>
<li>方便的委派(delegation)
可以在Generator里委派另一个Generator来生成数据，简单直接的写法：</li>
</ul>

<pre><code>&lt;?php
function gen() {
    yield 1;
    yield 2;
    yield from gen2();
}

function gen2() {
    yield 3;
    yield 4;
}

foreach (gen() as $val) {
    echo $val, PHP_EOL;
}

// ===== OUTPUT =====
// 1
// 2
// 3
// 4
?&gt;
</code></pre>

<h2>
<a id="session选项配置更灵活" class="anchor" href="#session%E9%80%89%E9%A1%B9%E9%85%8D%E7%BD%AE%E6%9B%B4%E7%81%B5%E6%B4%BB" aria-hidden="true"><span class="octicon octicon-link"></span></a>Session选项配置更灵活</h2>

<p>以往session的选项是在php.ini中配置的，现在可以把这些选项以数组的方式传参给session_start()函数，例如：</p>

<pre><code>&lt;?php
session_start([
    'cache_limiter' =&gt; 'private',
    'read_and_close' =&gt; true,
]);
?&gt;
</code></pre>

<h2>
<a id="use声明可分组" class="anchor" href="#use%E5%A3%B0%E6%98%8E%E5%8F%AF%E5%88%86%E7%BB%84" aria-hidden="true"><span class="octicon octicon-link"></span></a>use声明可分组</h2>

<p>在同一命名空间下import的类、函数、常量现在可以写在同一个use中，作为一个分组，直接看例子：</p>

<pre><code>&lt;?php
// PHP 7 之前
use some\namespace\ClassA;
use some\namespace\ClassB;
use some\namespace\ClassC as C;

use function some\namespace\fn_a;
use function some\namespace\fn_b;
use function some\namespace\fn_c;

use const some\namespace\ConstA;
use const some\namespace\ConstB;
use const some\namespace\ConstC;

// PHP 7+ 后
use some\namespace\{ClassA, ClassB, ClassC as C};
use function some\namespace\{fn_a, fn_b, fn_c};
use const some\namespace\{ConstA, ConstB, ConstC};
?&gt;
</code></pre>

<h2>
<a id="引入静态类型语言的精粹" class="anchor" href="#%E5%BC%95%E5%85%A5%E9%9D%99%E6%80%81%E7%B1%BB%E5%9E%8B%E8%AF%AD%E8%A8%80%E7%9A%84%E7%B2%BE%E7%B2%B9" aria-hidden="true"><span class="octicon octicon-link"></span></a>引入静态类型语言的精粹</h2>

<ul>
<li>函数参数类型声明(Scalar Type Hints)
在函数参数前面声明参数类型，默认不强制检查参数类型，若传参类型与声明不匹配，解释器会自动转换类型而不报任何错误与警告。但你也可以启用严格模式(strict mode)，让解释器执行传参类型检查，若类型不匹配则抛出Fatal error: Uncaught TypeError。例如：</li>
</ul>

<pre><code>&lt;?php
declare(strict_types = 1);  // 在php文件的第一行声明使用严格模式
function double(int $value){
   return 2 * $value;
}
$a = double("5");
var_dump($a);
</code></pre>

<ul>
<li>函数返回值类型声明(Return Type Hints)
在函数定义的括号后用: type声明返回值类型，例如:</li>
</ul>

<pre><code>&lt;?php
function a() : bool{
   return 1;
}
var_dump(a());
</code></pre>

<p>返回时会自动把1转换为true，与上面的函数参数类型声明一样，在严格模式下会报错:</p>

<pre><code>Fatal error: Uncaught TypeError: Return value of a() must be of the type boolean, integer returned
</code></pre>

<h2>
<a id="匿名类" class="anchor" href="#%E5%8C%BF%E5%90%8D%E7%B1%BB" aria-hidden="true"><span class="octicon octicon-link"></span></a>匿名类</h2>

<p>写惯java或python的朋友应该很高兴，因为终于等到了这个在静态类型语言中很寻常的匿名类特性。PHP7中可通过new class的方式直接创建匿名类的实例(当你要抛出异常对象时可能会感受到这特性的好处————无须再定义整个具体的异常类了)：</p>

<pre><code>&lt;?php
interface Logger {
    public function log(string $msg);
}

class Application {
    private $logger;

    public function getLogger(): Logger {
         return $this-&gt;logger;
    }

    public function setLogger(Logger $logger) {
         $this-&gt;logger = $logger;
    }
}

$app = new Application;
$app-&gt;setLogger(new class implements Logger {
    public function log(string $msg) {
        echo $msg;
    }
});

var_dump($app-&gt;getLogger());
?&gt;
</code></pre>

<p>上面会输出：</p>

<pre><code>object(class@anonymous)#2 (0) {
}
</code></pre>

<h2>
<a id="可以用define来定义常量数组" class="anchor" href="#%E5%8F%AF%E4%BB%A5%E7%94%A8define%E6%9D%A5%E5%AE%9A%E4%B9%89%E5%B8%B8%E9%87%8F%E6%95%B0%E7%BB%84" aria-hidden="true"><span class="octicon octicon-link"></span></a>可以用define来定义常量数组</h2>

<p>PHP5.6时，常量数组只能用const来定义，PHP7后可以用define()来定义了：</p>

<pre><code>&lt;?php
define('ANIMALS', [
    'dog',
    'cat',
    'bird'
]);

echo ANIMALS[1]; // outputs "cat"
?&gt;
</code></pre>

<h2>
<a id="新的运算符" class="anchor" href="#%E6%96%B0%E7%9A%84%E8%BF%90%E7%AE%97%E7%AC%A6" aria-hidden="true"><span class="octicon octicon-link"></span></a>新的运算符</h2>

<ul>
<li><p>"&lt;=&gt;"运算符，用于比较两个表达式： 
$a &lt;=&gt; $b 返回 
  -1: if $a &gt; $b
  0: if $a == $b
  1: if $a &lt; $b</p></li>
<li><p>取默认值运算符: "??"，从此可以打少好多字符
in php5: </p></li>
</ul>

<pre><code>$a = isset($b) ? $b : 'default';
</code></pre>

<p>in php7:</p>

<pre><code>$a = $b ?? 'default';

// Coalescing can be chained: this will return the first
// defined value out of $_GET['user'], $_POST['user'], and
// 'nobody'.
$username = $_GET['user'] ?? $_POST['user'] ?? 'nobody';
</code></pre>

<h1>
<a id="不兼容的地方" class="anchor" href="#%E4%B8%8D%E5%85%BC%E5%AE%B9%E7%9A%84%E5%9C%B0%E6%96%B9" aria-hidden="true"><span class="octicon octicon-link"></span></a>不兼容的地方</h1>

<h2>
<a id="error与exception的转变" class="anchor" href="#error%E4%B8%8Eexception%E7%9A%84%E8%BD%AC%E5%8F%98" aria-hidden="true"><span class="octicon octicon-link"></span></a>error与exception的转变</h2>

<p>很多fatal与recoverable fatal error被转换成exception了，这意味着你自定义的error handler不会被触发，因为不再有error，只会抛exception，exception需要你cache。</p>

<h2>
<a id="构造函数失败时会抛异常" class="anchor" href="#%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%A4%B1%E8%B4%A5%E6%97%B6%E4%BC%9A%E6%8A%9B%E5%BC%82%E5%B8%B8" aria-hidden="true"><span class="octicon octicon-link"></span></a>构造函数失败时会抛异常</h2>

<p>PHP7前，某些php内部的类在构造失败时会返回NULL或一个不可用的对象，但现在会直接抛Exception，你需要去catch，否则会出错。</p>

<h2>
<a id="改变了e_strict通知的严重性" class="anchor" href="#%E6%94%B9%E5%8F%98%E4%BA%86e_strict%E9%80%9A%E7%9F%A5%E7%9A%84%E4%B8%A5%E9%87%8D%E6%80%A7" aria-hidden="true"><span class="octicon octicon-link"></span></a>改变了E_STRICT通知的严重性</h2>

<p>所有的E_STRICT通知都被重新分类到其它级别，但E_STRICT这个常量依然保留，只是error_reporting(E_ALL|E_STRICT)不会再产生任何错误。</p>

<h2>
<a id="新的抽象语法树导致变量解释方式的不兼容" class="anchor" href="#%E6%96%B0%E7%9A%84%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91%E5%AF%BC%E8%87%B4%E5%8F%98%E9%87%8F%E8%A7%A3%E9%87%8A%E6%96%B9%E5%BC%8F%E7%9A%84%E4%B8%8D%E5%85%BC%E5%AE%B9" aria-hidden="true"><span class="octicon octicon-link"></span></a>新的抽象语法树导致变量解释方式的不兼容</h2>

<p>PHP7使用了新的抽象语法树来解释源代码，这样可以提高了语言的表达性（一些以前很奇怪难懂的写法现在可以用很简单直观的方式来表达了），但同时也带来了一些向后兼容性的问题。</p>

<ul>
<li>变量解释方向相反了
非直接变量（变量、属性、方法）现在会严格地遵从“从左到右”的解释规则，而非以前的混合方式。 新旧两种间接表达式的解释方式对比: </li>
</ul>

<table>
<thead>
<tr>
<th>Expression</th>
<th>PHP 5 interpretation</th>
<th>PHP 7 interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td>$$foo['bar']['baz']</td>
<td>${$foo['bar']['baz']}</td>
<td>($$foo)['bar']['baz']</td>
</tr>
<tr>
<td>$foo-&gt;$bar['baz']</td>
<td>$foo-&gt;{$bar['baz']}</td>
<td>($foo-&gt;$bar)['baz']</td>
</tr>
<tr>
<td>$foo-&gt;$bar<a href="">'baz'</a>
</td>
<td>$foo-&gt;{$bar['baz']}()</td>
<td>($foo-&gt;$bar)<a href="">'baz'</a>
</td>
</tr>
<tr>
<td>Foo::$bar<a href="">'baz'</a>
</td>
<td>Foo::{$bar['baz']}()</td>
<td>(Foo::$bar)<a href="">'baz'</a>
</td>
</tr>
</tbody>
</table>

<ul>
<li>list()的赋值顺序相反了
以前list()是反向的顺序，现在按定义的顺序来赋值。例如：</li>
</ul>

<pre><code>&lt;?php
list($a[], $a[], $a[]) = [1, 2, 3];
var_dump($a);
?&gt;
</code></pre>

<p>PHP 5 会输出：</p>

<pre><code>array(3) {
  [0]=&gt;
  int(3)
  [1]=&gt;
  int(2)
  [2]=&gt;
  int(1)
}
</code></pre>

<p>PHP 7 会输出：</p>

<pre><code>array(3) {
  [0]=&gt;
  int(1)
  [1]=&gt;
  int(2)
  [2]=&gt;
  int(3)
}
</code></pre>

<ul>
<li>list()不允许无参调用
直接看例子，以下在PHP7中会报错：</li>
</ul>

<pre><code>&lt;?php
list() = $a;
list(,,) = $a;
list($x, list(), $y) = $a;
?&gt;
</code></pre>

<h2>
<a id="foreach的重要变化" class="anchor" href="#foreach%E7%9A%84%E9%87%8D%E8%A6%81%E5%8F%98%E5%8C%96" aria-hidden="true"><span class="octicon octicon-link"></span></a>foreach的重要变化</h2>

<ul>
<li><p>foreach传值调用操作是数组的副本。 
这意味着默认的情况下你在foreach里修改数据的数据不会影响到原数组。</p></li>
<li><p>传引用调用时会动态检测到数据的变化
简单地说，就是你在foreach里添加或删除数据元素，会直接影响到当前正在操作的数组，直接看代码：</p></li>
</ul>

<pre><code>&lt;?php
$array = [0];
foreach ($array as &amp;$val) {
    var_dump($val);
    $array[1] = 1;
}
?&gt;
</code></pre>

<p>在PHP 5会输出：</p>

<pre><code>int(0)
</code></pre>

<p>而PHP 7会输出：</p>

<pre><code>int(0)
int(1)
</code></pre>

<h2>
<a id="yield不再是函数而是一个右关联的运算符" class="anchor" href="#yield%E4%B8%8D%E5%86%8D%E6%98%AF%E5%87%BD%E6%95%B0%E8%80%8C%E6%98%AF%E4%B8%80%E4%B8%AA%E5%8F%B3%E5%85%B3%E8%81%94%E7%9A%84%E8%BF%90%E7%AE%97%E7%AC%A6" aria-hidden="true"><span class="octicon octicon-link"></span></a>yield不再是函数，而是一个右关联的运算符</h2>

<p>即是不需要加括号()，例如：</p>

<pre><code>&lt;?php
echo yield -1;
// Was previously interpreted as
echo (yield) - 1;
// And is now interpreted as
echo yield (-1);

yield $foo or die;
// Was previously interpreted as
yield ($foo or die);
// And is now interpreted as
(yield $foo) or die;
?&gt;
</code></pre>

<h1>
<a id="benchmark-detail" class="anchor" href="#benchmark-detail" aria-hidden="true"><span class="octicon octicon-link"></span></a>Benchmark Detail</h1>

<p>用相同的ab参数： </p>

<pre><code>ab -n 1000 -c 200 http://php5.batman.me/wordpress/ 
</code></pre>

<h2>
<a id="-round-1-" class="anchor" href="#-round-1-" aria-hidden="true"><span class="octicon octicon-link"></span></a>====== Round 1 ======</h2>

<h3>
<a id="condition" class="anchor" href="#condition" aria-hidden="true"><span class="octicon octicon-link"></span></a>CONDITION</h3>

<ul>
<li>nginx worker: 10</li>
<li>php-fpm max_children: 15</li>
<li>requests: 1000</li>
<li>concurrency: 200</li>
</ul>

<h3>
<a id="result" class="anchor" href="#result" aria-hidden="true"><span class="octicon octicon-link"></span></a>RESULT</h3>

<table>
<thead>
<tr>
<th>php7</th>
<th>php5</th>
</tr>
</thead>
<tbody>
<tr>
<td>Request per second:</td>
<td>327.85</td>
</tr>
<tr>
<td>Time per request:</td>
<td>2.75(ms)</td>
</tr>
</tbody>
</table>

<h2>
<a id="-round-2-" class="anchor" href="#-round-2-" aria-hidden="true"><span class="octicon octicon-link"></span></a>====== Round 2 ======</h2>

<h3>
<a id="condition-1" class="anchor" href="#condition-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>CONDITION</h3>

<ul>
<li>nginx worker: 20</li>
<li>php-fpm max_children: 15</li>
<li>requests: 1000</li>
<li>concurrency: 200</li>
</ul>

<h3>
<a id="result-1" class="anchor" href="#result-1" aria-hidden="true"><span class="octicon octicon-link"></span></a>RESULT</h3>

<table>
<thead>
<tr>
<th>php7</th>
<th>php5</th>
</tr>
</thead>
<tbody>
<tr>
<td>Request per second:</td>
<td>354.15</td>
</tr>
<tr>
<td>Time per request:</td>
<td>2.824(ms)</td>
</tr>
</tbody>
</table>

<h2>
<a id="-round-3-" class="anchor" href="#-round-3-" aria-hidden="true"><span class="octicon octicon-link"></span></a>====== Round 3 ======</h2>

<h3>
<a id="condition-2" class="anchor" href="#condition-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>CONDITION</h3>

<ul>
<li>nginx worker: 20</li>
<li>php-fpm max_children: 15</li>
<li>requests: 1000</li>
<li>concurrency: 500</li>
</ul>

<h3>
<a id="result-2" class="anchor" href="#result-2" aria-hidden="true"><span class="octicon octicon-link"></span></a>RESULT</h3>

<table>
<thead>
<tr>
<th>php7</th>
<th>php5</th>
</tr>
</thead>
<tbody>
<tr>
<td>Request per second:</td>
<td>346.62</td>
</tr>
<tr>
<td>Time per request:</td>
<td>2.885(ms)</td>
</tr>
</tbody>
</table>

<h1>
<a id="性能报告图表" class="anchor" href="#%E6%80%A7%E8%83%BD%E6%8A%A5%E5%91%8A%E5%9B%BE%E8%A1%A8" aria-hidden="true"><span class="octicon octicon-link"></span></a>性能报告图表</h1>

<p>自带的sapi benchmark:</p>

<p><img src="https://raw.githubusercontent.com/sunshine17/sunshine17.github.io/master/images/synthetic-bench-2.jpg" alt="自带的sapi benchmark"></p>

<p>性能统计图:</p>

<p><img src="https://raw.githubusercontent.com/sunshine17/sunshine17.github.io/master/images/statistic.jpg" alt="性能统计图"></p>

<p>ab测试1:</p>

<p><img src="https://raw.githubusercontent.com/sunshine17/sunshine17.github.io/master/images/ab-1.jpg" alt="ab测试1"></p>

<p>ab测试2:</p>

<p><img src="https://raw.githubusercontent.com/sunshine17/sunshine17.github.io/master/images/ab-2.jpg" alt="ab测试2"></p>
      </section>

    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>
